rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * MERCAFLOW PORTAL - SECURITY RULES
     * 
     * Centralized role-based access control.
     * Roles: client, admin, superadmin, picker, purchaser, salesperson.
     */

    // --- GLOBAL HELPER FUNCTIONS ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Helper to get the requester's user document
    function getRequesterData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Checks if the requester has a specific role
    function hasRole(role) {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
             getRequesterData().role == role;
    }

    function isSuperAdmin() {
      return hasRole('superadmin');
    }

    function isAdmin() {
      return isSuperAdmin() || hasRole('admin');
    }

    function hasSalesRole() {
      return isAdmin() || hasRole('salesperson');
    }

    function hasPurchasingRole() {
      return isAdmin() || hasRole('purchaser');
    }

    function hasPickingRole() {
      return isAdmin() || hasRole('picker');
    }

    // --- COLLECTION RULES ---

    /**
     * USERS & PROFILES
     */
    match /users/{userId} {
      // Users can read their own profile. SuperAdmins can see all.
      allow get: if isOwner(userId) || isSuperAdmin();
      allow list: if isSuperAdmin();
      
      // Allow profile creation during signup
      allow create: if isOwner(userId);
      
      // Allow update if owner (but not role) or superadmin
      allow update: if (isOwner(userId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role'])) 
                    || isSuperAdmin();
      
      allow delete: if isSuperAdmin();

      // Sub-collections inside users
      match /notifications/{id} { allow read, update, delete: if isOwner(userId); }
      match /branches/{id} { allow read, write: if isOwner(userId); }
      match /notes/{id} { allow read, write: if isAdmin(); }
      match /rewardsActivity/{id} { 
        allow read: if isOwner(userId) || isAdmin();
        allow write: if isAdmin();
      }
    }

    /**
     * PRODUCT CATALOG
     */
    match /products/{productId} {
      allow read: if isSignedIn();
      allow write: if hasPurchasingRole();
    }
    
    match /productCategories/{id} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    match /productUnits/{id} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    match /offerCategories/{id} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    match /offers/{id} { allow read: if isSignedIn(); allow write: if isAdmin(); }

    /**
     * SUPPLIERS & PROCUREMENT
     */
    match /suppliers/{supplierId} {
      allow read, write: if hasPurchasingRole();
    }
    
    match /purchaseOrders/{poId} {
      allow read, write: if hasPurchasingRole();
    }

    /**
     * ORDERS
     */
    match /orders/{orderId} {
      // Clients see their own. Pickers and Admins see all.
      allow get: if isOwner(resource.data.userId) || hasPickingRole();
      allow list: if isSignedIn(); // Filtering must be done in the query
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if hasPickingRole();
      allow delete: if isAdmin();
    }

    /**
     * SALES & PROSPECTS
     */
    match /prospects/{prospectId} {
      // Owners (salespeople) or admins can access
      allow read, update: if hasSalesRole() && (resource.data.salespersonId == request.auth.uid || isAdmin());
      allow create: if hasSalesRole();
      allow delete: if isAdmin();

      match /visits/{visitId} {
        allow read, write: if hasSalesRole() && (get(/databases/$(database)/documents/prospects/$(prospectId)).data.salespersonId == request.auth.uid || isAdmin());
      }
    }

    /**
     * SUPPORT & BILLING
     */
    match /supportTickets/{id} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read, update: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
      allow delete: if isAdmin();
    }

    match /invoices/{id} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow write: if isAdmin();
    }

    /**
     * REWARDS & LOYALTY
     */
    match /rewardTiers/{id} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    match /rewards/{id} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    match /rewardRules/{id} { allow read, write: if isAdmin(); }

    /**
     * ADMINISTRATION
     */
    match /adminInvites/{email} {
      allow read, create, delete: if isSuperAdmin();
      allow get: if !isSignedIn(); // For signup check
      allow update: if isSignedIn() && request.auth.token.email == email;
    }
    
    match /pricelists/{id} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
  }
}